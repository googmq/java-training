# InnoDB与MyISAM数据存储

## MyISAM数据存储方式

### 数据在磁盘上存放方式

+ 存放顺序：数据按照数据插入的顺序存储在磁盘上
+ 辅助数据：根据数据格式额外为每行数据标记“行号”，因此可以快速跳过所需的字节找到需要的行

### 索引数据存储方式

+ Primary key：B+Tree树的叶子节点存放索引值和对应数据行的“行号”，不保存数据行实际的内容
+ Secondary key：B+Tree树的叶子节点存放索引值和对应数据行的“行号”，不保存数据行实际的内容

## InnoDB数据存储方式

### 数据在磁盘上存放方式

+ 存放顺序：数据按照Primary key的顺序存储在磁盘上

### 索引数据存储方式

+ Primary key：B+Tree树的叶子节点包含了主键值、事务ID、用于事务和MVCC的回滚指针和完整的数据行
+ Secondary key：B+Tree树的叶子节点只包含了索引列的值和对应的主键值，通过主键值从主键聚簇索引中找到对应的行数据

## 对比

|                           | InnoDb                                  | MyISAM                                 |
| ------------------------- | --------------------------------------- | -------------------------------------- |
| 硬盘上数据存放顺序        | 按Primary key顺序存放                   | 按数据插入顺序存放                     |
| Primary key内存中辅助数据 | 事务ID、用于事务和MVCC的回滚指针        |                                        |
| Primary key数据内容       | 叶子节点存放索引列的值和完整的数据行    | 叶子节点存放索引列的值和数据行的“行号” |
| Secondary key数据内容     | 叶子节点存放索引列的值和Primary key的值 | 叶子节点存放索引列的值和数据行的“行号” |

## 聚簇索引

数据行的内容存放在索引的叶子页中，因此一张表只能有一个聚簇索引。

InnoDB就是聚簇索引方式，数据文件就是Primary key的B+Tree树本身。

### 优点

- 相关数据保存在一起，可以通过少量IO就获取全部数据，避免随机IO
- 数据访问更快，索引和数据都在同一个B-Tree中，读取数据比从非聚簇索引读取数据更快
- 使用Secondary key覆盖索引扫描的查询可以直接使用页节点中的主键值

### 缺点

+ 数据插入速度严重依赖插入顺序，按照主键顺序插入是加载数据最快的方式
+ 更新聚簇索引代价很高，因为可能会强制将更新的行移动到新的位置
+ 基于聚簇索引的表在插入新行或主键被更新导致移动行时，可能面临“页分裂”的问题。需要将一行记录插入到某个已满的页中，会导致该页分裂成两个页面来容纳数据，导致占用更多的磁盘空间
+ 聚簇索引可能导致全表扫描变慢，尤其是行比较稀疏时
+ 二级索引的叶子节点仅包含了引用行的主键值
+ 二级索引访问需要两次索引查找，第一次找到引用行的主键，第二次使用主键在聚簇索引中找到数据行